# QUNIX Handler Fix Deployment Guide

**Version:** 1.0.0  
**Target:** Production QUNIX systems  
**Fixes:** Handler population with full execution chain

---

## Overview

This patch fixes the command handlers in your QUNIX database by:

1. **Schema-aware installation** - Detects v7, v11, or v12+ schemas automatically
2. **Complete handler chain** - Command → Handler → QASM → Microcode → Binary
3. **Quantum circuits** - Grover search, quantum walks, amplitude amplification
4. **Man pages** - Comprehensive documentation for all commands
5. **Working filesystem** - ls, tree, find, locate, pwd, cd, mkdir, rm, cat

---

## Prerequisites

### Required

- QUNIX database (`qunix_leech.db`)
- Python 3.8+
- SQLite3
- NumPy

### Optional (for quantum execution)

- Qiskit 1.0+
- Qiskit-Aer

```bash
pip install qiskit qiskit-aer numpy
```

---

## Installation Steps

### Step 1: Verify Current State

```bash
# Check database exists
ls -lh qunix_leech.db

# Verify schema
sqlite3 qunix_leech.db "SELECT name FROM sqlite_master WHERE type='table' AND name='command_handlers'"
```

### Step 2: Backup Database

**CRITICAL: Always backup before patching!**

```bash
cp qunix_leech.db qunix_leech.db.backup.$(date +%Y%m%d_%H%M%S)
```

### Step 3: Apply Handler Fix Patch

```bash
# Make executable
chmod +x db_patch_handler_fix_v1.py

# Apply patch (installs batch 1 and 2 by default)
python3 db_patch_handler_fix_v1.py qunix_leech.db

# Or install specific batches
python3 db_patch_handler_fix_v1.py qunix_leech.db --batch=1,2
```

**Expected output:**

```
╔══════════════════════════════════════════════════════════════╗
║  QUNIX HANDLER FIX PATCH v1.0.0-HANDLER-FIX                  ║
║  Production Grade Handler Installation                       ║
╚══════════════════════════════════════════════════════════════╝

Schema Detection:
  Version: v12+
  FK Strategy: cmd_name
  Tables: 87

Ensuring required tables...
  ✓ All required tables present

Inserting Batch 1: Search Commands...
  ✓ Created: ls
  ✓ Created: dir
  ✓ Created: tree
  ✓ Created: find
  ✓ Created: locate
  ✓ Batch 1: Search Commands complete

Inserting Batch 2: Basic Commands...
  ✓ Created: pwd
  ✓ Created: cd
  ✓ Created: mkdir
  ✓ Created: rm
  ✓ Created: cat
  ✓ Batch 2: Basic Commands complete

Inserting Man Pages...
  ✓ Created man: ls
  ✓ Created man: tree
  ✓ Created man: find
  ✓ Created man: locate
  ✓ Created man: pwd
  ✓ Created man: cd
  ✓ Created man: mkdir
  ✓ Created man: rm
  ✓ Created man: cat
  ✓ Man pages complete

Creating Microcode Sequences...
  ✓ Microcode sequences created

Verifying Installation...

  Testing commands:
    ls              Handler:✓ Circuit:✓ Man:✓
    tree            Handler:✓ Circuit:✓ Man:✓
    find            Handler:✓ Circuit:✓ Man:✓
    locate          Handler:✓ Circuit:✓ Man:✓
    pwd             Handler:✓ Circuit:✓ Man:✓

  Summary:
    Handlers: 10
    Circuits: 5
    Man pages: 9

✓ Patch completed in 1.2s

══════════════════════════════════════════════════════════════
HANDLER FIX PATCH COMPLETE
══════════════════════════════════════════════════════════════

Statistics:
  Handlers created: 10
  Circuits created: 5
  Man pages created: 9

Schema:
  Version: v12+
  FK Strategy: cmd_name

✓ All handlers installed and verified

Test commands:
  ls
  tree
  find . test
  locate qunix
  pwd
  help ls
```

### Step 4: Verify Installation

```bash
# Run integration tests
chmod +x test_handlers_integration.py
python3 test_handlers_integration.py qunix_leech.db

# Or quick test
python3 test_handlers_integration.py qunix_leech.db --quick
```

### Step 5: Test Handlers with CPU

```bash
# Start CPU
python3 qunix_cpu.py --db qunix_leech.db

# Test commands
qunix> pwd
qunix> ls
qunix> tree
qunix> find . test
qunix> help ls
qunix> status
```

---

## Command Reference

### Batch 1: Search Commands (Quantum Advantage)

| Command | Description | Qubits | Algorithm |
|---------|-------------|--------|-----------|
| `ls [path]` | List directory | 8 | Grover search |
| `dir [path]` | List directory (alias) | 8 | Grover search |
| `tree [path]` | Directory tree | 10 | Quantum walk |
| `find <path> <pattern>` | Search files | 8 | Grover search |
| `locate <pattern>` | Fast indexed search | 6 | Amplitude amplification |

### Batch 2: Basic Commands

| Command | Description | Qubits | Type |
|---------|-------------|--------|------|
| `pwd` | Print working directory | 3 | Metadata |
| `cd <path>` | Change directory | 3 | Metadata |
| `mkdir <path>` | Create directory | 3 | Metadata |
| `rm <file>` | Remove file | 3 | Metadata |
| `cat <file>` | Display file | 3 | Metadata |

---

## Usage Examples

### List Directory with Quantum Search

```bash
qunix> ls
  home/
  quantum/
  sys/
  proc/
  dev/

qunix> ls /home
  test.txt
  data/
  README.md
```

### Directory Tree with Quantum Walk

```bash
qunix> tree
/
├── home/
│   ├── test.txt
│   └── data/
│       └── file.dat
├── quantum/
└── sys/

qunix> tree --depth=2
# Limits traversal depth
```

### Find Files with Grover Search

```bash
qunix> find . "*.py"
./qunix_cpu.py
./qunix_db_executor.py
./qunix_fs.py

qunix> find /home test
/home/test.txt
/home/data/test.dat
```

### Fast Locate with Amplitude Amplification

```bash
qunix> locate qunix
/qunix_cpu.py
/qunix_db_executor.py
/qunix_leech.db

qunix> locate .db
/qunix_leech.db
/data/test.db
```

### Help System

```bash
qunix> help ls
ls
  Category: FILESYSTEM
  Description: List directory contents with quantum search
  Qubits: 8
  Gate: grover
  Handler: FILESYSTEM
  QASM: 45 lines

  Arguments:
    arg_0 (string, optional)

  Flags:
    --shots (integer)

qunix> help tree
tree
  Category: FILESYSTEM
  Description: Display directory tree with quantum walk traversal
  Qubits: 10
  ...
```

---

## Troubleshooting

### Problem: "command_handlers table not found"

**Solution:** Your schema is pre-v7. Apply base patches first:

```bash
python3 ls_dir_tree_find_locate.py qunix_leech.db
```

### Problem: "No handler in database: ls"

**Solution:** Run the handler fix patch:

```bash
python3 db_patch_handler_fix_v1.py qunix_leech.db
```

### Problem: "QASM execution failed"

**Solution:** Install Qiskit:

```bash
pip install qiskit qiskit-aer
```

### Problem: "No such directory"

**Solution:** Initialize filesystem:

```bash
sqlite3 qunix_leech.db <<EOF
INSERT OR IGNORE INTO fs_inodes (inode_id, inode_type, mode, nlink, size, atime, mtime, ctime, crtime)
VALUES (1, 'd', 493, 2, 0, strftime('%s', 'now'), strftime('%s', 'now'), strftime('%s', 'now'), strftime('%s', 'now'));
EOF
```

### Problem: "Qubits stuck allocated"

**Solution:** Clean qubit allocator:

```bash
sqlite3 qunix_leech.db "UPDATE cpu_qubit_allocator SET allocated=0, allocated_to_pid=NULL WHERE allocated=1"
```

---

## Advanced Configuration

### Custom Quantum Shots

```bash
qunix> ls --shots=4096
# Uses 4096 quantum measurements instead of default 1024
```

### Debug Mode

```bash
python3 qunix_cpu.py --db qunix_leech.db --debug
```

### Schema Introspection

```bash
qunix> tables
# Shows all database tables

qunix> schema command_handlers
# Shows table schema

qunix> debug_handlers ls
# Shows handler debug info
```

---

## Architecture

### Execution Chain

```
Terminal Input
    ↓
Command Registry (cmd_name → cmd_opcode)
    ↓
Command Handler (handler_type → implementation)
    ↓
QASM Circuit (quantum_command_circuits)
    ↓
Microcode Sequences (cpu_microcode_sequences)
    ↓
Micro Primitives (cpu_micro_primitives)
    ↓
Qiskit Execution (AerSimulator)
    ↓
Measurement Results (cpu_measurement_results)
    ↓
State Update (q table)
    ↓
Terminal Output
```

### Handler Types

- **QUANTUM_CIRCUIT** - Executes QASM via Qiskit
- **FILESYSTEM** - Database filesystem operations
- **SQL_QUERY** - Direct SQL execution
- **PYTHON_METHOD** - Python method call
- **BUILTIN** - Built-in command
- **OPCODE_MICROCODE** - Full microcode chain

---

## Performance

### Quantum Advantage

| Operation | Classical | Quantum | Speedup |
|-----------|-----------|---------|---------|
| Directory search (1000 files) | O(N) = 1000 | O(√N) ≈ 32 | 31x |
| Tree traversal (depth 10) | O(N) | O(√N) | ~10x |
| File location (indexed) | O(log N) | O(√log N) | ~2x |

### Benchmarks

```bash
# Benchmark ls on large directory
time ls /large_dir

# Compare with classical
time find /large_dir -maxdepth 1
```

---

## Security

### Permissions

All filesystem operations respect standard Unix permissions:

- Directories: 755 (rwxr-xr-x) default
- Files: 644 (rw-r--r--) default

### Quantum State Isolation

Each session has isolated quantum state via:

- Session ID in fs_cwd table
- Qubit allocation tracking
- Process ID tagging

---

## Future Batches

### Batch 3: File Metadata (Coming Soon)

- `touch` - Create empty file
- `chmod` - Change permissions
- `stat` - File statistics
- `df` - Disk usage
- `du` - Directory usage

### Batch 4: File Operations (Coming Soon)

- `cp` - Copy files
- `mv` - Move/rename files
- `ln` - Create links
- `readlink` - Read symlink
- `which` - Locate command

### Batch 5: Text Processing (Coming Soon)

- `grep` - Pattern search
- `head` - First N lines
- `tail` - Last N lines
- `wc` - Word count
- `file` - Determine file type

---

## Support

### Getting Help

```bash
# General help
qunix> help

# Command-specific help
qunix> help <command>

# Manual page
qunix> man <command>

# System status
qunix> status
```

### Debugging

```bash
# Enable debug mode
export QUNIX_DEBUG=1
python3 qunix_cpu.py --db qunix_leech.db

# Check handler detection
qunix> debug_handlers ls
qunix> debug_handlers tree
```

### Reporting Issues

When reporting issues, include:

1. Schema version: `qunix> status`
2. Handler status: `qunix> debug_handlers <cmd>`
3. Error message
4. Command that failed

---

## Changelog

### v1.0.0 (2026-01-10)

- Initial release
- Batch 1: Search commands (ls, dir, tree, find, locate)
- Batch 2: Basic commands (pwd, cd, mkdir, rm, cat)
- Schema auto-detection (v7, v11, v12+)
- Comprehensive man pages
- Microcode sequences
- Integration tests

---

## License

Part of the QUNIX project. See main project for license details.

---

**Last updated:** 2026-01-10  
**Maintainer:** QUNIX Development Team  
**Version:** 1.0.0-HANDLER-FIX

